<!DOCTYPE html>
<html>
<head>
    <title>Painel de Controle - Detector de CO</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="favicon.jpeg">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        /* --- ESTILOS GERAIS --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; transition: background-color 0.3s ease, color 0.3s ease; } /* Added transition */
        #map { height: 60vh; width: 100%; border-bottom: 1px solid #ccc; cursor: pointer; transition: border-color 0.3s ease; }
        .dashboard { padding: 25px; text-align: center; transition: background-color 0.3s ease; }
        .dashboard h1 { margin-top: 0; color: #1c1e21; transition: color 0.3s ease; }
        .card-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 20px 30px; min-width: 220px; transition: transform 0.2s, background-color 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card h2 { margin-top: 0; font-size: 1.2em; color: #606770; transition: color 0.3s ease; }
        .card .value { font-size: 3em; font-weight: 700; line-height: 1.2; }
        #current-device-id { color: #555; font-weight: bold; height: 20px; margin-top: 15px; transition: color 0.3s ease; }
        .status-safe { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }

        /* --- ESTILOS PAINEL DE STATUS --- */
        .room-panel-container { padding: 20px 25px; background-color: #fff; text-align: center; border-bottom: 1px solid #ccc; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .room-panel-container h2 { margin-top: 0; margin-bottom: 20px; transition: color 0.3s ease; }
        #room-panel { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding-bottom: 20px; }
        .room-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; min-width: 200px; text-align: left; transition: all 0.2s ease, background-color 0.3s ease, border-color 0.3s ease; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left-width: 6px; }
        .room-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .room-card h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.2em; color: #1c1e21; transition: color 0.3s ease; }
        .room-card p { font-size: 1.5em; font-weight: 600; margin: 0; transition: color 0.3s ease; }
        .room-card.status-safe { border-left-color: #28a745; }
        .room-card.status-safe p { color: #28a745; }
        .room-card.status-warning { border-left-color: #ffc107; background-color: #fffbeb; }
        .room-card.status-warning p { color: #c09100; }
        .room-card.status-danger { border-left-color: #dc3545; background-color: #fff0f1; animation: pulse-danger 1.5s infinite; }
        .room-card.status-danger p { color: #dc3545; }
        @keyframes pulse-danger { 0% { background-color: #fff0f1; } 50% { background-color: #ffe0e3; } 100% { background-color: #fff0f1; } }

        /* --- ESTILOS CARD ID USU√ÅRIO --- */
        #user-info-card { text-align: left; }
        #user-info-card p { font-size: 0.9em; line-height: 1.4; transition: color 0.3s ease; }
        #user-uid-display { background-color: #fff; border: 1px solid #ccc; padding: 5px 8px; border-radius: 4px; font-family: monospace; font-size: 1.1em; color: #c7254e; word-wrap: break-word; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        
        /* --- ESTILOS LOGIN --- */
        #login-container { text-align: center; padding: 40px 20px; max-width: 400px; margin: 50px auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        #login-container h1 { margin-top: 0; transition: color 0.3s ease; }
        .login-form input { width: 90%; padding: 12px 15px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        .login-buttons { display: flex; gap: 10px; justify-content: center; }
        .login-buttons button { padding: 10px 15px; font-size: 1em; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        #login-button-email { background-color: #007bff; color: white; }
        #register-button-email { background-color: #6c757d; color: white; }
        .divider { margin: 20px 0; font-weight: bold; color: #888; transition: color 0.3s ease; }
        #google-login-button { font-size: 1.1em; padding: 12px 20px; cursor: pointer; background-color: #4285F4; color: white; border: none; border-radius: 5px; font-weight: bold; width: 90%; }
        #login-error-message { color: #dc3545; font-weight: bold; height: 20px; }

        /* --- ESTILOS LOGOUT & TEMA --- */
        #logout-container { text-align: right; padding: 10px 20px; background-color: #e9ecef; transition: background-color 0.3s ease; }
        #logout-container span { margin-right: 15px; font-weight: bold; transition: color 0.3s ease; }
        #logout-button, #theme-toggle-button { cursor: pointer; background: #6c757d; color: white; border: none; border-radius: 5px; padding: 5px 10px; }
        #theme-toggle-button { margin-right: 10px; background-color: #5a6268; } /* Estilo ligeiramente diferente para o bot√£o de tema */

        /* ============================================= */
        /* ESTILOS DO TEMA ESCURO              */
        /* ============================================= */

        body.dark-theme { background-color: #121212; color: #e0e0e0; }
        body.dark-theme #map { border-bottom-color: #333; }
        body.dark-theme .dashboard, body.dark-theme .room-panel-container, body.dark-theme #logout-container { background-color: #1e1e1e; border-bottom-color: #333; }
        body.dark-theme h1, body.dark-theme h2, body.dark-theme h3 { color: #ffffff; }
        body.dark-theme #current-device-id { color: #bbbbbb; }
        body.dark-theme .card { background-color: #2c2c2c; box-shadow: 0 4px 8px rgba(0,0,0,0.4); border-color: #444; }
        body.dark-theme .card h2 { color: #cccccc; }
        body.dark-theme #user-info-card { background-color: #3a3a3a; border-color: #555; }
        body.dark-theme #user-info-card p { color: #d0d0d0; }
        body.dark-theme #user-uid-display { background-color: #222; border-color: #555; color: #ff8a8a; }
        body.dark-theme .room-card { background-color: #2c2c2c; border-color: #444; }
        body.dark-theme .room-card h3 { color: #ffffff; }
        body.dark-theme .room-card.status-warning { background-color: #4d3a00; border-left-color: #ffc107; }
        body.dark-theme .room-card.status-warning p { color: #ffeb9b; }
        body.dark-theme .room-card.status-danger { background-color: #5c1a1f; border-left-color: #dc3545; animation: none; }
        body.dark-theme .room-card.status-danger p { color: #ffacb1; }
        body.dark-theme #login-container { background-color: #1e1e1e; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        body.dark-theme .login-form input { background-color: #3a3a3a; border-color: #555; color: #e0e0e0; }
        body.dark-theme .login-form input::placeholder { color: #888; }
        body.dark-theme .divider { color: #aaa; }
        body.dark-theme #logout-container span { color: #212529; } /* Ajuste cor do email no logout dark */

    </style>
</head>
<body>

<div id="login-container">
    <h1>Bem-vindo!</h1>
    <p>Fa√ßa login ou crie sua conta para continuar.</p>
    <div class="login-form">
        <input type="email" id="login-email" placeholder="Seu e-mail" required>
        <input type="password" id="login-password" placeholder="Sua senha" required>
        <p id="login-error-message"></p>
        <div class="login-buttons">
            <button id="login-button-email">Entrar</button>
            <button id="register-button-email">Criar Conta</button>
        </div>
    </div>
    <div class="divider">OU</div>
    <button id="google-login-button">Entrar com Google</button>
</div>

<div id="content-container" style="display: none;">
    <div id="logout-container">
        <span id="user-email"></span>
        <button id="theme-toggle-button" style="margin-right: 10px;">üåì</button> 
        <button id="logout-button">Sair</button>
    </div>

    <div class="dashboard">
        <h1>Monitoramento de Mon√≥xido de Carbono</h1>
        <h3 id="current-device-id">Selecione um dispositivo no mapa ou painel</h3>
        <div class="card-container">
            <div class="card">
                <h2>N√≠vel Atual (PPM)</h2>
                <p class="value" id="current-ppm">--</p>
            </div>
            <div class="card">
                <h2>Status</h2>
                <p class="value" id="current-status">--</p>
            </div>
            <div class="card" id="user-info-card">
                <h2>Seu ID de Usu√°rio</h2>
                <p>Para adicionar um novo dispositivo, use este ID no portal de configura√ß√£o:</p>
                <code id="user-uid-display">Carregando...</code>
            </div>
        </div>
    </div>

    <div class="room-panel-container">
        <h2>Painel de Status dos Dispositivos</h2>
        <div id="room-panel">
            </div>
    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    // Configura√ß√£o do Firebase (sem altera√ß√µes)
    const firebaseConfig = {
      apiKey: "AIzaSyC__Rkv0nXP20RL31mRsQGH-xOuABbnW5s",
      authDomain: "mostra-f2718.firebaseapp.com",
      databaseURL: "https://mostra-f2718-default-rtdb.firebaseio.com",
      projectId: "mostra-f2718",
      storageBucket: "mostra-f2718.firebasestorage.app",
      messagingSenderId: "581453261928",
      appId: "1:581453261928:web:5b92c9aa0cf0cbe4fd5fdd"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ============================================= //
    //          C√ìDIGO DO TEMA (LIGHT/DARK)          //
    // ============================================= //
    const themeToggleButton = document.getElementById('theme-toggle-button');
    const bodyElement = document.body;
    let currentMapLayer = null; // NOVO: Vari√°vel para guardar a camada do mapa

    // URLs das camadas de mapa
    const lightMapUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const lightMapAttribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
    const darkMapUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    const darkMapAttribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>';

    // NOVO: Fun√ß√£o para atualizar o tema do mapa
    function updateMapTheme(theme) {
        if (currentMapLayer) {
            map.removeLayer(currentMapLayer); // Remove a camada antiga
        }
        
        let newUrl = lightMapUrl;
        let newAttribution = lightMapAttribution;
        
        if (theme === 'dark') {
            newUrl = darkMapUrl;
            newAttribution = darkMapAttribution;
        }
        
        // Adiciona a nova camada
        currentMapLayer = L.tileLayer(newUrl, { attribution: newAttribution }).addTo(map);
    }

    // Verifica tema salvo e aplica
    const currentTheme = localStorage.getItem('theme');
    if (currentTheme === 'dark') {
        bodyElement.classList.add('dark-theme');
        if(themeToggleButton) themeToggleButton.textContent = '‚òÄÔ∏è'; 
        // updateMapTheme('dark'); // Mapa ser√° atualizado pelo onAuthStateChanged
    } else {
         if(themeToggleButton) themeToggleButton.textContent = 'üåì'; 
        // updateMapTheme('light'); // Mapa ser√° atualizado pelo onAuthStateChanged
    }

    // Evento de clique no bot√£o de tema
    if (themeToggleButton) {
        themeToggleButton.onclick = () => {
            bodyElement.classList.toggle('dark-theme');
            let theme = 'light';
            if (bodyElement.classList.contains('dark-theme')) {
                theme = 'dark';
                themeToggleButton.textContent = '‚òÄÔ∏è'; 
            } else {
                themeToggleButton.textContent = 'üåì'; 
            }
            localStorage.setItem('theme', theme);
            updateMapTheme(theme); // ATUALIZA O MAPA QUANDO CLICA
        };
    }
    // ============================================= //

    // Refer√™ncias aos elementos do HTML
    const loginContainer = document.getElementById('login-container');
    const contentContainer = document.getElementById('content-container');
    const logoutButton = document.getElementById('logout-button');
    const userEmailElement = document.getElementById('user-email');
    const roomPanel = document.getElementById('room-panel');
    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const loginEmailButton = document.getElementById('login-button-email');
    const registerEmailButton = document.getElementById('register-button-email');
    const googleLoginButton = document.getElementById('google-login-button');
    const loginErrorMessage = document.getElementById('login-error-message');

    // Inicializa√ß√£o do Mapa (REMOVIDO O TILELAYER DAQUI)
    const map = L.map('map').setView([-19.9208, -44.0542], 13);
    // L.tileLayer(...) FOI REMOVIDO DAQUI E MOVIDO PARA A FUN√á√ÉO updateMapTheme
    
    const markers = {};
    let activeMarker = null;
    let devicesRef = null;

    // Fun√ß√µes de Login/Logout/Erro (sem altera√ß√µes)
    const provider = new firebase.auth.GoogleAuthProvider();
    googleLoginButton.onclick = () => { auth.signInWithPopup(provider).catch(handleAuthError); };
    loginEmailButton.onclick = () => { /* ...c√≥digo sem altera√ß√£o... */ };
    registerEmailButton.onclick = () => { /* ...c√≥digo sem altera√ß√£o... */ };
    logoutButton.onclick = () => { auth.signOut(); };
    function handleAuthError(error) { /* ...c√≥digo sem altera√ß√£o... */ }

    // Ouvinte de Autentica√ß√£o (MODIFICADO para chamar updateMapTheme)
    auth.onAuthStateChanged((user) => {
        if (user) {
            contentContainer.style.display = 'block';
            loginContainer.style.display = 'none';
            userEmailElement.textContent = `Logado como: ${user.email}`;
            loginErrorMessage.textContent = "";
            document.getElementById('user-uid-display').textContent = user.uid;
            
            // CHAMA A ATUALIZA√á√ÉO DO MAPA AQUI, AP√ìS O LOGIN
            updateMapTheme(localStorage.getItem('theme') || 'light'); 
            
            map.invalidateSize(); // Garante que o mapa redesenhe corretamente
            
            const userUid = user.uid;
            devicesRef = database.ref('dispositivos_por_usuario/' + userUid);
            startDatabaseListener(devicesRef);
        } else {
            contentContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            if (devicesRef) { devicesRef.off(); }
            clearDashboardAndMap();
            // Remove a camada do mapa ao deslogar
             if (currentMapLayer) {
                map.removeLayer(currentMapLayer);
                currentMapLayer = null;
            }
        }
    });

    // Fun√ß√µes do Dashboard (sem altera√ß√µes)
    function startDatabaseListener(ref) { /* ...c√≥digo sem altera√ß√£o... */ }
    function clearDashboardAndMap() { /* ...c√≥digo sem altera√ß√£o... */ }
    function updateDashboard(data, deviceId) { /* ...c√≥digo sem altera√ß√£o... */ }
    function highlightDevice(deviceId, deviceData) { /* ...c√≥digo sem altera√ß√£o... */ }
    function updateMapMarker(id, data) { /* ...c√≥digo sem altera√ß√£o... */ }
    function updateRoomPanel(deviceId, deviceData) { /* ...c√≥digo sem altera√ß√£o... */ }

</script>
</body>
</html>
