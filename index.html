<!DOCTYPE html>
<html>
<head>
    <title>Painel de Controle - Detector de CO</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="favicon.jpeg">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        /* --- ESTILOS GERAIS (sem alteração) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; transition: background-color 0.3s ease, color 0.3s ease; }
        #map { height: 60vh; width: 100%; border-bottom: 1px solid #ccc; cursor: pointer; transition: border-color 0.3s ease; }
        .dashboard { padding: 25px; text-align: center; transition: background-color 0.3s ease; }
        .dashboard h1 { margin-top: 0; color: #1c1e21; transition: color 0.3s ease; }
        .card-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 20px 30px; min-width: 220px; transition: transform 0.2s, background-color 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card h2 { margin-top: 0; font-size: 1.2em; color: #606770; transition: color 0.3s ease; }
        .card .value { font-size: 3em; font-weight: 700; line-height: 1.2; }
        #current-device-id { color: #555; font-weight: bold; height: 20px; margin-top: 15px; transition: color 0.3s ease; }
        .status-safe { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }

        /* --- ESTILOS PAINEL DE STATUS (sem alteração) --- */
        .room-panel-container { padding: 20px 25px; background-color: #fff; text-align: center; border-bottom: 1px solid #ccc; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .room-panel-container h2 { margin-top: 0; margin-bottom: 20px; transition: color 0.3s ease; }
        #room-panel { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding-bottom: 20px; }
        .room-card { position: relative; border: 1px solid #ddd; border-radius: 8px; padding: 15px; min-width: 200px; text-align: left; transition: all 0.2s ease, background-color 0.3s ease, border-color 0.3s ease; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left-width: 6px; }
        .room-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .room-card h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.2em; color: #1c1e21; transition: color 0.3s ease; }
        .room-card p { font-size: 1.5em; font-weight: 600; margin: 0; transition: color 0.3s ease; }
        .room-card.status-safe { border-left-color: #28a745; }
        .room-card.status-safe p { color: #28a745; }
        .room-card.status-warning { border-left-color: #ffc107; background-color: #fffbeb; }
        .room-card.status-warning p { color: #c09100; }
        .room-card.status-danger { border-left-color: #dc3545; background-color: #fff0f1; animation: pulse-danger 1.5s infinite; }
        .room-card.status-danger p { color: #dc3545; }
        @keyframes pulse-danger { 0% { background-color: #fff0f1; } 50% { background-color: #ffe0e3; } 100% { background-color: #fff0f1; } }

        /* --- ESTILOS CARD ID USUÁRIO (sem alteração) --- */
        #user-info-card { text-align: left; }
        #user-info-card p { font-size: 0.9em; line-height: 1.4; transition: color 0.3s ease; }
        #user-uid-display { background-color: #fff; border: 1px solid #ccc; padding: 5px 8px; border-radius: 4px; font-family: monospace; font-size: 1.1em; color: #c7254e; word-wrap: break-word; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        
        /* --- ESTILOS LOGIN (sem alteração) --- */
        #login-container { text-align: center; padding: 40px 20px; max-width: 400px; margin: 50px auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        #login-container h1 { margin-top: 0; transition: color 0.3s ease; }
        .login-form input { width: 90%; padding: 12px 15px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        .login-buttons { display: flex; gap: 10px; justify-content: center; }
        .login-buttons button { padding: 10px 15px; font-size: 1em; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        #login-button-email { background-color: #007bff; color: white; }
        #register-button-email { background-color: #6c757d; color: white; }
        .divider { margin: 20px 0; font-weight: bold; color: #888; transition: color 0.3s ease; }
        #google-login-button { font-size: 1.1em; padding: 12px 20px; cursor: pointer; background-color: #4285F4; color: white; border: none; border-radius: 5px; font-weight: bold; width: 90%; }
        #login-error-message { color: #dc3545; font-weight: bold; height: 20px; }

        /* ============================================= */
        /* NOVO CSS PARA TELA DE REGISTRO       */
        /* ============================================= */
        #register-container {
            text-align: center;
            padding: 40px 20px;
            max-width: 450px; /* Um pouco mais largo */
            margin: 50px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none; /* COMEÇA ESCONDIDO */
        }
        #register-container h1 { margin-top: 0; }
        #register-container .login-form input { width: 90%; }
        #register-container .login-buttons { justify-content: center; }
        #confirm-register-button { background-color: #28a745; color: white; } /* Botão verde */
        #cancel-register-button { background-color: #6c757d; color: white; }
        #register-error-message { color: #dc3545; font-weight: bold; height: 20px; }
        body.dark-theme #register-container { background-color: #1e1e1e; }
        /* ============================================= */

        /* --- ESTILOS LOGOUT & TEMA (sem alteração) --- */
        #logout-container { text-align: right; padding: 10px 20px; background-color: #e9ecef; transition: background-color 0.3s ease; }
        #logout-container span { margin-right: 15px; font-weight: bold; transition: color 0.3s ease; }
        #logout-button, #theme-toggle-button { cursor: pointer; background: #6c757d; color: white; border: none; border-radius: 5px; padding: 5px 10px; }
        #theme-toggle-button { margin-right: 10px; background-color: #5a6268; }

        /* --- ESTILO BOTÃO REMOVER (sem alteração) --- */
        .room-card { position: relative; }
        .remove-btn { position: absolute; top: 5px; right: 5px; background-color: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 18px; text-align: center; cursor: pointer; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; }
        .remove-btn:hover { background-color: #c82333; opacity: 1; }

        /* --- ESTILOS TEMA ESCURO (sem alteração) --- */
        /* ... (todo o seu body.dark-theme ... ) ... */
        body.dark-theme { background-color: #121212; color: #e0e0e0; }
        body.dark-theme #map { border-bottom-color: #333; }
        body.dark-theme .dashboard, body.dark-theme .room-panel-container, body.dark-theme #logout-container { background-color: #1e1e1e; border-bottom-color: #333; }
        body.dark-theme h1, body.dark-theme h2, body.dark-theme h3 { color: #ffffff; }
        body.dark-theme #current-device-id { color: #bbbbbb; }
        body.dark-theme .card { background-color: #2c2c2c; box-shadow: 0 4px 8px rgba(0,0,0,0.4); border-color: #444; }
        body.dark-theme .card h2 { color: #cccccc; }
        body.dark-theme #user-info-card { background-color: #3a3a3a; border-color: #555; }
        body.dark-theme #user-info-card p { color: #d0d0d0; }
        body.dark-theme #user-uid-display { background-color: #222; border-color: #555; color: #ff8a8a; }
        body.dark-theme .room-card { background-color: #2c2c2c; border-color: #444; }
        body.dark-theme .room-card h3 { color: #ffffff; }
        body.dark-theme .room-card.status-warning { background-color: #4d3a00; border-left-color: #ffc107; }
        body.dark-theme .room-card.status-warning p { color: #ffeb9b; }
        body.dark-theme .room-card.status-danger { background-color: #5c1a1f; border-left-color: #dc3545; animation: none; }
        body.dark-theme .room-card.status-danger p { color: #ffacb1; }
        body.dark-theme #login-container { background-color: #1e1e1e; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        body.dark-theme #register-container { background-color: #1e1e1e; }
        body.dark-theme .login-form input { background-color: #3a3a3a; border-color: #555; color: #e0e0e0; }
        body.dark-theme .login-form input::placeholder { color: #888; }
        body.dark-theme .divider { color: #aaa; }
        body.dark-theme #logout-container span { color: #e0e0e0; }
        body.dark-theme .remove-btn { background-color: #a02a33; }
        body.dark-theme .remove-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>

<div id="login-container">
    <h1>Bem-vindo!</h1>
    <p>Faça login ou crie sua conta para continuar.</p>
    <div class="login-form">
        <input type="email" id="login-email" placeholder="Seu e-mail" required>
        <input type="password" id="login-password" placeholder="Sua senha" required>
        <p id="login-error-message"></p>
        <div class="login-buttons">
            <button id="login-button-email">Entrar</button>
            <button id="register-button-email">Criar Conta</button> </div>
    </div>
    <div class="divider">OU</div>
    <button id="google-login-button">Entrar com Google</button>
</div>

<div id="register-container" style="display: none;">
    <h1>Criar Nova Conta</h1>
    <p>Preencha seus dados para se registrar.</p>
    <div class="login-form">
        <input type="text" id="register-name" placeholder="Seu nome completo" required>
        <input type="email" id="register-email" placeholder="Seu e-mail" required>
        <input type="password" id="register-password" placeholder="Crie uma senha (mín. 6 caracteres)" required>
        <input type="text" id="register-dob" placeholder="Data de Nascimento (DD/MM/AAAA)" required>
        <input type="text" id="register-address" placeholder="Seu endereço" required>
        <p id="register-error-message"></p>
        
        <div class="login-buttons">
            <button id="confirm-register-button">Confirmar Cadastro</button>
            <button id="cancel-register-button">Cancelar</button>
        </div>
    </div>
</div>
<div id="content-container" style="display: none;">
    <div id="logout-container">
        <span id="user-email"></span>
        <button id="theme-toggle-button" style="margin-right: 10px;">🌓</button> 
        <button id="logout-button">Sair</button>
    </div>

    <div class="dashboard">
        <h1>Monitoramento de Monóxido de Carbono</h1>
        <h3 id="current-device-id">Selecione um dispositivo no mapa ou painel</h3>
        <div class="card-container">
            <div class="card">
                <h2>Nível Atual (PPM)</h2>
                <p class="value" id="current-ppm">--</p>
            </div>
            <div class="card">
                <h2>Status</h2>
                <p class="value" id="current-status">--</p>
            </div>
            <div class="card" id="user-info-card">
                <h2>Seu ID de Usuário</h2>
                <p>Para adicionar um novo dispositivo, use este ID no portal de configuração:</p>
                <code id="user-uid-display">Carregando...</code>
            </div>
        </div>
    </div>

    <div class="room-panel-container">
        <h2>Painel de Status dos Dispositivos</h2>
        <div id="room-panel">
            </div>
    </div>

    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    // Configuração do Firebase (sem alteração)
    const firebaseConfig = {
      apiKey: "AIzaSyC__Rkv0nXP20RL31mRsQGH-xOuABbnW5s",
      authDomain: "mostra-f2718.firebaseapp.com",
      databaseURL: "https://mostra-f2718-default-rtdb.firebaseio.com",
      projectId: "mostra-f2718",
      storageBucket: "mostra-f2718.appspot.com",
      messagingSenderId: "581453261928",
      appId: "1:581453261928:web:5b92c9aa0cf0cbe4fd5fdd"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    // Espera o HTML carregar
    document.addEventListener('DOMContentLoaded', () => {

        console.log("DOM Carregado. Iniciando script principal.");

        // Referências aos elementos do HTML (Antigos)
        const loginContainer = document.getElementById('login-container');
        const contentContainer = document.getElementById('content-container');
        const logoutButton = document.getElementById('logout-button');
        const userEmailElement = document.getElementById('user-email');
        const roomPanel = document.getElementById('room-panel');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginEmailButton = document.getElementById('login-button-email');
        const registerEmailButton = document.getElementById('register-button-email'); // Botão na tela de Login
        const googleLoginButton = document.getElementById('google-login-button');
        const loginErrorMessage = document.getElementById('login-error-message');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const bodyElement = document.body;
        
        // --- NOVAS REFERÊNCIAS AOS ELEMENTOS DE REGISTRO ---
        const registerContainer = document.getElementById('register-container');
        const registerNameInput = document.getElementById('register-name');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const registerDobInput = document.getElementById('register-dob');
        const registerAddressInput = document.getElementById('register-address');
        const confirmRegisterButton = document.getElementById('confirm-register-button');
        const cancelRegisterButton = document.getElementById('cancel-register-button');
        const registerErrorMessage = document.getElementById('register-error-message');
        
        // Mapa e variáveis globais
        let map = null;
        let currentMapLayer = null;
        const markers = {};
        let activeMarker = null;
        let devicesRef = null;

        // URLs das camadas de mapa (sem alteração)
        const lightMapUrl = '...'; const lightMapAttribution = '...';
        const darkMapUrl = '...'; const darkMapAttribution = '...';

        // --- CÓDIGO DO TEMA ---
        function updateMapTheme(theme) {
            if (!map) return; // Não faz nada se o mapa não foi inicializado
            if (currentMapLayer) { map.removeLayer(currentMapLayer); }
            let newUrl = lightMapUrl; let newAttribution = lightMapAttribution;
            if (theme === 'dark') {
                newUrl = darkMapUrl;
                newAttribution = darkMapAttribution;
            }
            currentMapLayer = L.tileLayer(newUrl, { attribution: newAttribution }).addTo(map);
        }
        
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'dark') {
            bodyElement.classList.add('dark-theme');
            if(themeToggleButton) themeToggleButton.textContent = '☀️';
        } else {
             if(themeToggleButton) themeToggleButton.textContent = '🌓';
        }

        if (themeToggleButton) {
            themeToggleButton.onclick = () => {
                bodyElement.classList.toggle('dark-theme');
                let theme = 'light';
                if (bodyElement.classList.contains('dark-theme')) {
                    theme = 'dark'; themeToggleButton.textContent = '☀️';
                } else { themeToggleButton.textContent = '🌓'; }
                localStorage.setItem('theme', theme);
                updateMapTheme(theme); // Chama a função que agora tem código
            };
        }
        // --- FIM CÓDIGO DO TEMA ---
        
        // --- FUNÇÕES DE LOGIN/LOGOUT/ERRO (sem alteração) ---
        function handleAuthError(error, isRegistration = false) { // Modificada para aceitar erros de registro
            let message = ""; console.warn("Erro Auth:", error.code, error.message);
            switch (error.code) {
                case "auth/wrong-password": message = "Senha incorreta."; break;
                case "auth/user-not-found": message = "Usuário não encontrado."; break;
                case "auth/email-already-in-use": message = "E-mail já em uso. Tente fazer login."; break;
                case "auth/weak-password": message = "Senha fraca (mín. 6 caracteres)."; break;
                case "auth/invalid-email": message = "E-mail inválido."; break;
                default: message = "Erro. Tente novamente.";
            }
            // Escolhe onde exibir a mensagem de erro
            if (isRegistration) {
                if (registerErrorMessage) registerErrorMessage.textContent = message;
            } else {
                if (loginErrorMessage) loginErrorMessage.textContent = message;
            }
        }

        // ========================================================== //
        //          VINCULA OS CLIQUES DOS BOTÕES AQUI                //
        // ========================================================== //

        // Botão SAIR
        if (logoutButton) { logoutButton.onclick = () => { auth.signOut(); }; }
        
        // Botão LOGIN COM GOOGLE
        if (googleLoginButton) { googleLoginButton.onclick = () => { auth.signInWithPopup(provider).catch((err) => handleAuthError(err, false)); }; }
        
        // Botão LOGIN COM E-MAIL
        if (loginEmailButton) {
            loginEmailButton.onclick = () => {
                const email = loginEmailInput.value; const password = loginPasswordInput.value;
                if (!email || !password) { if(loginErrorMessage) loginErrorMessage.textContent = "Preencha e-mail e senha."; return; }
                auth.signInWithEmailAndPassword(email, password).catch((err) => handleAuthError(err, false));
            };
        }
        
        // --- LÓGICA DE NAVEGAÇÃO DE FORMULÁRIO (NOVA) ---
        
        // Botão "CRIAR CONTA" (na tela de login) - AGORA SÓ MOSTRA O FORMULÁRIO
        if (registerEmailButton) {
            registerEmailButton.onclick = () => {
                if (loginContainer) loginContainer.style.display = 'none';
                if (registerContainer) registerContainer.style.display = 'block';
                if (loginErrorMessage) loginErrorMessage.textContent = ""; // Limpa erros antigos
            };
        }
        
        // Botão "CANCELAR" (na tela de registro)
        if (cancelRegisterButton) {
            cancelRegisterButton.onclick = () => {
                if (loginContainer) loginContainer.style.display = 'block';
                if (registerContainer) registerContainer.style.display = 'none';
                if (registerErrorMessage) registerErrorMessage.textContent = ""; // Limpa erros antigos
            };
        }

        // Botão "CONFIRMAR CADASTRO" (NOVO - A LÓGICA PRINCIPAL)
        if (confirmRegisterButton) {
            confirmRegisterButton.onclick = () => {
                // 1. Coleta todos os dados do formulário de registro
                const name = registerNameInput.value;
                const email = registerEmailInput.value;
                const password = registerPasswordInput.value;
                const dob = registerDobInput.value;
                const address = registerAddressInput.value;
                
                // Validação simples
                if (!name || !email || !password || !dob || !address) {
                    if(registerErrorMessage) registerErrorMessage.textContent = "Por favor, preencha todos os campos.";
                    return;
                }
                
                console.log("Tentando criar conta com e-mail...");
                
                // 2. Cria o usuário no AUTHENTICATION
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        console.log("Conta criada com sucesso:", userCredential.user.uid);
                        const user = userCredential.user;
                        
                        // 3. Salva os dados extras no REALTIME DATABASE
                        const userProfile = {
                            nome: name,
                            email: email,
                            dataNascimento: dob,
                            endereco: address,
                            criadoEm: new Date().toISOString()
                        };
                        
                        // Cria uma nova "pasta" para perfis de usuário
                        database.ref('perfis_usuarios/' + user.uid).set(userProfile)
                            .then(() => {
                                console.log("Perfil do usuário salvo no Database.");
                                // O onAuthStateChanged vai detectar o login e mudar para o dashboard.
                                // Não precisamos fazer nada aqui.
                            })
                            .catch(dbError => {
                                console.error("Erro ao salvar perfil no DB:", dbError);
                                // O usuário foi criado, mas o perfil falhou. Lidar com isso se necessário.
                                handleAuthError(dbError, true);
                            });
                            
                    })
                    .catch((error) => {
                        // Erro ao criar a conta (ex: e-mail já existe)
                        handleAuthError(error, true); // true = mostrar erro no form de registro
                    });
            };
        }
        // ========================================================== //


        // --- LÓGICA DE AUTENTICAÇÃO (onAuthStateChanged) ---
        auth.onAuthStateChanged((user) => {
            console.log(">>> PASSO A: onAuthStateChanged disparado. User:", user ? user.uid : "null");
           if (user) {
                // ----- USUÁRIO LOGADO -----
                console.log(">>> PASSO B: Usuário logado detectado. UID:", user.uid);

                // 1. Mostra o conteúdo
                if(contentContainer) contentContainer.style.display = 'block';
                if(loginContainer) loginContainer.style.display = 'none';
                if(userEmailElement) userEmailElement.textContent = `Logado como: ${user.email}`;
                if(loginErrorMessage) loginErrorMessage.textContent = "";
                const userUidDisplay = document.getElementById('user-uid-display');
                if(userUidDisplay) userUidDisplay.textContent = user.uid;

                // ========================================================
                // CORREÇÃO: Inicializa o mapa AGORA (DEPOIS de estar visível)
                // ========================================================
                if (!map && document.getElementById('map')) { // Se o mapa ainda não foi inicializado
                    console.log(">>> Inicializando o mapa AGORA (pois está visível).");
                    map = L.map('map').setView([-19.9208, -44.0542], 13);
H               } else if (map) {
                     console.log(">>> Mapa já existe, apenas invalidando o tamanho.");
                     map.invalidateSize(); // Se já existe, só redimensiona
                }
                
                // 2. Agora, carregamos o tema do mapa (que adiciona os tiles)
                updateMapTheme(localStorage.getItem('theme') || 'light');
                // ========================================================
                
                // 3. Agora, buscamos os dados
                const userUid = user.uid;
                const userDevicesPath = 'dispositivos_por_usuario/' + userUid;
                console.log(">>> PASSO C: Preparando para ouvir:", userDevicesPath);
                if (!devicesRef) {
                    devicesRef = database.ref(userDevicesPath);
                    startDatabaseListener(devicesRef);
                }
            }

                updateMapTheme(localStorage.getItem('theme') || 'light');
                if (map) {
                    setTimeout(() => {
                        console.log(">>> Forçando redesenho do mapa (invalidateSize) e carregando tema...");
                        map.invalidateSize(); // 1. Força o mapa a ver o tamanho do div
                        updateMapTheme(localStorage.getItem('theme') || 'light'); // 2. AGORA carrega os tiles
                    }, 100); // 100ms de atraso para o CSS 'display: block' ser renderizado
                }

                const userUid = user.uid;
                const userDevicesPath = 'dispositivos_por_usuario/' + userUid;
                console.log(">>> PASSO C: Preparando para ouvir:", userDevicesPath);
                if (!devicesRef) {
                    devicesRef = database.ref(userDevicesPath);
                    startDatabaseListener(devicesRef);
                }
            } else {
                // ----- USUÁRIO DESLOGADO -----
                console.log(">>> Usuário deslogado.");
                if(contentContainer) contentContainer.style.display = 'none';
                if(loginContainer) loginContainer.style.display = 'block';
                if(registerContainer) registerContainer.style.display = 'none'; // Esconde o form de registro
                
                if (devicesRef) { devicesRef.off(); devicesRef = null; console.log(">>> Ouvinte DB removido."); }
                clearDashboardAndMap();
                if (currentMapLayer && map) { map.removeLayer(currentMapLayer); currentMapLayer = null; }
            }
        });

        // --- FUNÇÕES DO DASHBOARD (Definições completas) ---
        function startDatabaseListener(ref) { /* ... (código) ... */ }
        function clearDashboardAndMap() { /* ... (código) ... */ }
        function updateDashboard(data, deviceId) { /* ... (código) ... */ }
        function highlightDevice(deviceId, deviceData) { /* ... (código) ... */ }
        function updateMapMarker(id, data) { /* ... (código) ... */ }
        function updateRoomPanel(deviceId, deviceData) { /* ... (código) ... */ }
        function removeDevice(deviceId) { /* ... (código) ... */ }
        
        // (Aqui estão as definições completas que você já tinha)
        // ... (cole as definições completas de startDatabaseListener, clearDashboardAndMap, etc. aqui) ...
        // ... (Para economizar espaço, estou omitindo, mas cole-as do seu código anterior) ...

        // (Aqui está o preenchimento das funções que você já tinha)
        function startDatabaseListener(ref) {
            console.log(">>> PASSO D: Anexando listener:", ref.toString());
            ref.on('value', (snapshot) => {
                console.log(">>> PASSO E: Listener disparado! Snapshot:", snapshot.val() ? "COM DADOS" : "VAZIO");
                const allDevices = snapshot.val();
                console.log(">>> PASSO F: Conteúdo:", allDevices);
                clearDashboardAndMap();
                if (!allDevices) {
                    console.log(">>> PASSO G1: Nenhum dispositivo.");
                    if(roomPanel) roomPanel.innerHTML = '<p>Nenhum dispositivo encontrado. Adicione um novo!</p>';
                    return;
                }
                console.log(">>> PASSO G2: Dispositivos encontrados.");
                const devicesArray = Object.entries(allDevices);
                devicesArray.sort((a, b) => b[1].ppm - a[1].ppm);
                for (const [deviceId, deviceData] of devicesArray) {
                    console.log(">>> PASSO H: Processando:", deviceId);
                    if (deviceData && typeof deviceData.lat !== 'undefined' && typeof deviceData.lng !== 'undefined' && typeof deviceData.ppm !== 'undefined') {
                        updateMapMarker(deviceId, deviceData);
                        updateRoomPanel(deviceId, deviceData);
                    } else { console.warn(`>>> AVISO: Dados inválidos para ${deviceId}`, deviceData); }
                }
                console.log(">>> PASSO I: Processamento concluído.");
            }, (error) => { console.error(">>> ERRO listener:", error); });
        }

        function clearDashboardAndMap() {
            updateDashboard(null); 
            if(roomPanel) roomPanel.innerHTML = '';
            for (const markerId in markers) {
                if (map && markers[markerId]) { map.removeLayer(markers[markerId]); }
                delete markers[markerId];
            }
            if (activeMarker) { activeMarker = null; }
        }

        function updateDashboard(data, deviceId) {
             const ppmElement = document.getElementById('current-ppm');
             const statusElement = document.getElementById('current-status');
             const deviceIdElement = document.getElementById('current-device-id');
             if (!ppmElement || !statusElement || !deviceIdElement) return;
             if (!data) {
                ppmElement.textContent = "--"; statusElement.textContent = "--";
                deviceIdElement.textContent = "Selecione um dispositivo no mapa ou painel"; return;
            }
            deviceIdElement.textContent = `Mostrando dados do: ${deviceId}`;
            const ppm = data.ppm; ppmElement.textContent = ppm; 
            statusElement.className = "value";
            statusElement.classList.remove('status-safe', 'status-warning', 'status-danger');
            if (ppm < 50) { statusElement.textContent = "Seguro"; statusElement.classList.add('status-safe'); }
            else if (ppm < 100) { statusElement.textContent = "Atenção"; statusElement.classList.add('status-warning'); }
            else { statusElement.textContent = "Perigo"; statusElement.classList.add('status-danger'); }
        }

        function highlightDevice(deviceId, deviceData) {
            if (!map || !markers[deviceId]) return;
            if (activeMarker) {
                if (activeMarker.styleNormal) activeMarker.setStyle(activeMarker.styleNormal);
                else activeMarker.setStyle({ radius: 8, fillOpacity: 0.8, stroke: false });
            }
            activeMarker = markers[deviceId];
            const ppm = deviceData.ppm; let color = '#28a745';
            if (ppm >= 100) color = '#dc3545'; else if (ppm >= 50) color = '#ffc107';
            const styleSelected = { radius: 10, fillOpacity: 1, stroke: true, weight: 3, color: '#fff', fillColor: color };
            activeMarker.setStyle(styleSelected);
            map.setView([deviceData.lat, deviceData.lng], 17);
            updateDashboard(deviceData, deviceId);
            activeMarker.openPopup();
        }

        function updateMapMarker(id, data) {
            console.log(`>>> updateMapMarker: Processando ${id}`);
            if (!map) { console.error(">>> updateMapMarker: ERRO - Mapa não inicializado!"); return; }
            const { lat, lng, ppm } = data; let color = '#28a745';
            if (ppm >= 100) color = '#dc3545'; else if (ppm >= 50) color = '#ffc107';
            const styleNormal = { radius: 8, fillOpacity: 0.8, stroke: false, fillColor: color };
            try {
                if (!markers[id]) {
                    markers[id] = L.circleMarker([lat, lng], styleNormal).addTo(map);
                    console.log(`>>> updateMapMarker: Marcador ${id} CRIADO.`);
                } else {
                     markers[id].setLatLng([lat, lng]);
                     markers[id].setStyle(styleNormal);
                     console.log(`>>> updateMapMarker: Marcador ${id} ATUALIZADO.`);
                }
                markers[id].styleNormal = styleNormal;
                const popupContent = `<b>Detector:</b> ${id}<br><b>Nível de CO:</b> ${ppm} PPM`;
                markers[id].bindPopup(popupContent);
                markers[id].off('click').on('click', () => { highlightDevice(id, data); });
            } catch (e) {
                console.error(`>>> updateMapMarker: ERRO INESPERADO ${id}:`, e);
            }
        }

        function updateRoomPanel(deviceId, deviceData) {
            console.log(`>>> updateRoomPanel: Criando card ${deviceId}`);
            if (!roomPanel) { console.error(">>> updateRoomPanel: ERRO - Painel não encontrado!"); return; }
            const ppm = deviceData.ppm;
            const card = document.createElement('div');
            card.className = 'room-card';
            let statusClass = 'status-safe';
            if (ppm >= 100) statusClass = 'status-danger';
            else if (ppm >= 50) statusClass = 'status-warning';
            card.classList.add(statusClass);
            card.innerHTML = `<h3>${deviceId}</h3><p>${ppm} PPM</p>`;
            const removeButton = document.createElement('button');
            removeButton.className = 'remove-btn';
            removeButton.textContent = 'X';
            removeButton.title = `Remover ${deviceId}`;
            removeButton.addEventListener('click', (event) => { event.stopPropagation(); removeDevice(deviceId); });
            card.appendChild(removeButton);
            card.addEventListener('click', () => { highlightDevice(deviceId, deviceData); });
            roomPanel.appendChild(card);
            console.log(`>>> updateRoomPanel: Card ${deviceId} ADICIONADO.`);
        }

        function removeDevice(deviceId) {
            if (confirm(`Tem certeza que deseja remover "${deviceId}"?`)) {
                const user = auth.currentUser;
                if (user) {
                    const devicePath = `dispositivos_por_usuario/${user.uid}/${deviceId}`;
                    console.log("Removendo:", devicePath);
                    database.ref(devicePath).remove()
                        .then(() => console.log(`Removido: ${deviceId}`))
                        .catch((error) => { console.error(`Erro ao remover ${deviceId}:`, error); alert(`Erro: ${error.message}`); });
                } else { console.error("Usuário não logado para remover."); }
            }
        }

    }); // --- FIM DO 'DOMContentLoaded' ---
</script>

</body>
</html>
